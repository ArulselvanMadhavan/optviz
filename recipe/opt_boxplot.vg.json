{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {"url": "data/opt_boxplot.json", "format": {"type": "json"}},
  "params": [
    {
      "name": "min_clamp",
      "value": 1,
      "bind": {"input": "range", "min": 0, "max": 1, "step": 0.05}
    },
    {
      "name": "max_clamp",
      "value": 1,
      "bind": {"input": "range", "min": 0, "max": 1, "step": 0.05}
    }
  ],
  "encoding": {"y": {"field": "layer", "type": "nominal", "sort": {}}},
  "width": 600,
  "transform": [{"flatten": ["outliers"]}],
  "layer": [
    {
      "mark": {"type": "rule"},
      "encoding": {
        "x": {
          "field": "lower",
          "type": "quantitative",
          "scale": {"zero": false},
          "title": null
        },
        "x2": {"field": "upper"}
      }
    },
    {
      "mark": {"type": "bar", "size": 14},
      "encoding": {
        "x": {"field": "q1", "type": "quantitative"},
        "x2": {"field": "q3"},
        "color": {
          "field": "layer",
          "type": "nominal",
          "sort": {},
          "legend": null
        },
        "tooltip": [
          {"field": "project", "type": "nominal", "title": "project"},
          {"field": "layer", "type": "nominal", "title": "layer"},
          {"field": "median", "type": "quantitative", "title": "median"},
          {"field": "q1", "type": "quantitative", "title": "first quartile"},
          {"field": "q3", "type": "quantitative", "title": "third quartile"},
          {
            "field": "lower",
            "type": "quantitative",
            "title": "whisker lower bound"
          },
          {
            "field": "upper",
            "type": "quantitative",
            "title": "whisker upper bound"
          }
        ]
      }
    },
    {
      "mark": {"type": "tick", "color": "white", "size": 1},
      "encoding": {"x": {"field": "median", "type": "quantitative"}}
    },
    {
      "mark": {"type": "point", "style": "boxplot-outliers"},
      "encoding": {
        "x": {"field": "outliers", "type": "quantitative"},
        "tooltip": [
          {
            "field": "outliers",
            "type": "quantitative",
            "title": "outlier_value"
          },
          {"field": "project", "type": "nominal", "title": "project"},
          {"field": "layer", "type": "nominal", "title": "layer"},
          {"field": "total", "type": "quantitative", "title": "total_outliers"},
          {
            "field": "q1_count",
            "type": "quantitative",
            "title": "outliers < first quartile"
          },
          {
            "field": "q3_count",
            "type": "quantitative",
            "title": "outliers > third quartile"
          }
        ]
      }
    },
    {
      "transform": [
        {
          "groupby": ["layer"],
          "aggregate": [{"field": "outliers", "op": "max", "as": "max_outlier"}]
        },
        {
          "calculate": "datum.max_outlier * max_clamp",
          "as": "max_outlier_clamped"
        }
      ],
      "mark": "rule",
      "encoding": {
        "x": {"field": "max_outlier_clamped", "type": "quantitative"},
        "y": {"field": "layer", "type": "nominal", "sort": {}},
        "y2": {"field": "layer", "bandPosition": 0},
        "color": {"value": "red"},
        "size": {"value": 2}
      }
    },
    {
      "transform": [
        {
          "groupby": ["layer"],
          "aggregate": [{"field": "outliers", "op": "min", "as": "min_outlier"}]
        },
        {
          "calculate": "datum.min_outlier * min_clamp",
          "as": "min_outlier_clamped"
        }
      ],
      "mark": "rule",
      "encoding": {
        "x": {"field": "min_outlier_clamped", "type": "quantitative"},
        "y": {"field": "layer", "type": "nominal", "sort": {}},
        "y2": {"field": "layer", "bandPosition": 0},
        "color": {"value": "black"},
        "size": {"value": 2}
      }
    }
  ]
}
